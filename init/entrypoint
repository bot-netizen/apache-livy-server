#!/bin/bash

# include bpkg  dependencies
source /usr/local/bin/retry
source /usr/local/bin/bgo
source /usr/local/bin/bgowait

function kick_livy_server(){

    export SPARK_HOME=/opt/spark-2.2.0-bin-hadoop2.7/

    echo "starting Livy Server!"
    /opt/apache-livy-0.6.0-incubating-bin/bin/livy-server start 

    # whatever blocking call 
    tail -f /dev/null
}

function start(){

    bgo kick_livy_server
    if [[ $? != 0 ]]; then
        echo "start failed. exiting now." >&2
        exit 1
    fi
}

function exit_alert() {
    if [[ $1 -ne 0 ]]; then 
        shift
        echo "$1 failed, exiting" 
        exit 1
    else    
        echo "$2 Success."
    fi
}


##-- Main Execution Starts Here --##
if [[ "$1" == "" ]]; then
    echo "Calling the start... "
else
    exec "$@"
fi

# start
start 
exit_alert "start" $?  

# configure
retry 5 5 "configure failed." configure
exit_alert "retry" $?  


# wait
echo "done. now waiting for services."
freq=5; waitForN=1; killTasks=1 #fail one, fail all (production mode)
bgowait $freq $waitForN $killTasks


